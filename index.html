<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pawfect Recipe Generator</title>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

  <style>
    /* Your existing CSS (keep all) */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      margin: 0;
      padding: 20px;
      color: #333;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }
    h1 { margin: 0; font-size: 2.5rem; }
    .subtitle { font-size: 1.2rem; opacity: 0.9; margin-top: 10px; }
    .form-section {
      padding: 30px;
      background: #f8f9fa;
    }
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    .form-group {
      display: flex;
      flex-direction: column;
    }
    label {
      margin-bottom: 8px;
      font-weight: 600;
      color: #555;
    }
    input, select {
      padding: 12px;
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.3s;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 14px 32px;
      font-size: 1.1rem;
      font-weight: 600;
      border-radius: 50px;
      cursor: pointer;
      transition: all 0.3s;
      align-self: flex-start;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }
    .result-section {
      padding: 30px;
      background: white;
      display: none;
    }
    footer {
      text-align: center;
      padding: 20px;
      color: #888;
      font-size: 0.9rem;
    }
    /* Login Modal */
    #login-modal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Pawfect Recipe Generator</h1>
      <p class="subtitle">Create personalized fresh food recipes for your dog</p>
    </header>

    <div class="form-section">
      <form id="recipe-form">
        <div class="form-grid">
          <div class="form-group">
            <label for="recipe-choice">Choose Recipe</label>
            <select id="recipe-choice" required>
              <option value="">Select a recipe...</option>
            </select>
          </div>
          <div class="form-group">
            <label for="dog-name">Dog's Name</label>
            <input type="text" id="dog-name" placeholder="e.g., Max" required />
          </div>
          <div class="form-group">
            <label for="dog-weight">Weight (kg)</label>
            <input type="number" id="dog-weight" step="0.1" min="0.5" placeholder="e.g., 10.5" required />
          </div>
          <div class="form-group">
            <label for="activity-level">Activity Level</label>
            <select id="activity-level" required>
              <option value="">Select activity level...</option>
              <option value="1.6">Puppy (up to 1 year)</option>
              <option value="1.8">Active Adult</option>
              <option value="1.6">Typical Adult</option>
              <option value="1.4">Senior/Less Active</option>
              <option value="1.2">Overweight/Prone</option>
            </select>
          </div>
          <div class="form-group">
            <label for="meals-per-day">Meals per Day</label>
            <select id="meals-per-day" required>
              <option value="2">2 meals</option>
              <option value="3">3 meals</option>
              <option value="1">1 meal</option>
            </select>
          </div>
        </div>
        <button type="submit" class="btn">Generate Recipe</button>
      </form>
    </div>

    <div id="result-section" class="result-section">
      <div id="recipe-output"></div>
    </div>
  </div>

  <footer>
    <p>© 2025 Pawfect Recipes • Not veterinary advice • Consult your vet</p>
  </footer>

  <!-- PAYWALL + MODAL ONLY -->
  <script>
    // === FIREBASE CONFIG ===
    const firebaseConfig = {
      apiKey: "AIzaSyAH1vDSk0CGzGwobDwPo0Kl0dB6dhKeNvk",
      authDomain: "pprecipe-pay-auth.firebaseapp.com",
      projectId: "pprecipe-pay-auth",
      storageBucket: "pprecipe-pay-auth.firebasestorage.app",
      messagingSenderId: "741698236045",
      appId: "1:741698236045:web:fcb73fe358747d4b3e7cc4"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // === POP-UP LOGIN MODAL ===
    function showLoginModal(formData) {
      const modal = document.createElement('div');
      modal.id = 'login-modal';
      modal.innerHTML = `
        <div style="background:white;padding:30px;border-radius:12px;width:90%;max-width:400px;text-align:center;">
          <h2>Log In to See Recipe</h2>
          <input id="modal-email" placeholder="Email" style="width:100%;margin:10px 0;padding:10px;border:1px solid #ccc;border-radius:6px;">
          <input id="modal-pass" type="password" placeholder="Password" style="width:100%;margin:10px 0;padding:10px;border:1px solid #ccc;border-radius:6px;">
          <button id="modal-signup" style="margin:5px;padding:10px 20px;background:#00695c;color:white;border:none;border-radius:6px;">Sign Up</button>
          <button id="modal-login" style="margin:5px;padding:10px 20px;background:#00897b;color:white;border:none;border-radius:6px;">Log In</button>
          <p id="modal-msg" style="color:red;margin-top:10px;"></p>
        </div>`;
      document.body.appendChild(modal);

      document.getElementById('modal-signup').onclick = () => {
        const email = document.getElementById('modal-email').value;
        const pass = document.getElementById('modal-pass').value;
        auth.createUserWithEmailAndPassword(email, pass)
          .then(u => { localStorage.setItem('uid', u.user.uid); modal.remove(); handleFormSubmitAfterLogin(formData); })
          .catch(e => document.getElementById('modal-msg').textContent = e.message);
      };

      document.getElementById('modal-login').onclick = () => {
        const email = document.getElementById('modal-email').value;
        const pass = document.getElementById('modal-pass').value;
        auth.signInWithEmailAndPassword(email, pass)
          .then(u => { localStorage.setItem('uid', u.user.uid); modal.remove(); handleFormSubmitAfterLogin(formData); })
          .catch(e => document.getElementById('modal-msg').textContent = e.message);
      };
    }

    function handleFormSubmitAfterLogin(formData) {
      const uid = localStorage.getItem('uid');
      db.collection('users').doc(uid).get().then(doc => {
        if (doc.exists && doc.data().paid) {
          showRecipeResults(formData);
        } else {
          const priceId = 'price_1SKbFNAMwnOW8DvN8M7ywBC1';
          fetch('https://pprecipe-backend.james-li-241.workers.dev/create-checkout-session', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ priceId, userId: uid })
          })
          .then(r => r.json())
          .then(data => window.location.href = data.url);
        }
      });
    }

    // === MAIN FORM SUBMIT ===
    async function handleFormSubmit(event) {
      event.preventDefault();

      const formData = {
        recipeId: formElements.recipeChoice.value,
        dogName: formElements.dogName.value,
        dogWeight: parseFloat(formElements.dogWeight.value),
        activityLevel: parseFloat(formElements.activityLevel.value),
        mealsPerDay: parseInt(formElements.mealsPerDay.value)
      };

      if (!formData.recipeId || !formData.dogName || isNaN(formData.dogWeight)) {
        alert('Please fill all fields!');
        return;
      }

      const uid = localStorage.getItem('uid');
      if (!uid) {
        showLoginModal(formData);
        return;
      }

      try {
        const userDoc = await db.collection('users').doc(uid).get();
        if (userDoc.exists && userDoc.data().paid) {
          showRecipeResults(formData);
          return;
        }
      } catch (error) {
        console.error("Firestore error:", error);
      }

      const priceId = 'price_1SKbFNAMwnOW8DvN8M7ywBC1';
      const response = await fetch('https://pprecipe-backend.james-li-241.workers.dev/create-checkout-session', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ priceId, userId: uid })
      });
      const { url } = await response.json();
      window.location.href = url;
    }

    function showRecipeResults(formData) {
      const selectedRecipe = recipes[formData.recipeId];
      const RER = 70 * Math.pow(formData.dogWeight, 0.75);
      const DER = RER * formData.activityLevel;
      const dailyFoodWeight = DER / selectedRecipe.caloriesPerGram;

      updateResultsUI(DER, dailyFoodWeight, formData, selectedRecipe);
      document.getElementById('result-section').style.display = 'block';
      document.getElementById('result-section').scrollIntoView({ behavior: 'smooth' });
    }

    // === YOUR ORIGINAL JS BELOW ===
    // Paste your full recipes object, formElements, updateResultsUI, etc. here
    // It must include:
    // const recipes = { ... }
    // const formElements = { ... }
    // form.addEventListener('submit', handleFormSubmit);

  </script>
</body>
</html>
